!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.d3=t.d3||{})}(this,function(t){"use strict";t.flamegraph=function(){var t=!1,e=!1,n=function(t){return t},i=function(t){return t.c||t.children},s=function(t){return t.n||t.name},r=function(t){return t.v||t.value},o=function(t){return t.d||t.delta},l=function(t){return{items:[t]}},h=function(t,e){t.items.push(e)},c=function(t){let e=0;const n=t.items;for(let t=n.length;t--;)e+=r(n[t]);return e},a=function(t){let e=0;const n=t.items;for(let t=n.length;t--;)e+=o(n[t]);return e};function u(t,e,n){this.parent=t,this.item=e,this.name=n,this.mark=0,this.bits=0}function d(){this.hasDelta=!1,this.maxDelta=0}function f(e){let n,i,s,r,o=null;const c=[e],a=t;for(;n=c.pop();)for(i=n.length;i--;)1&(r=(s=n[i]).mark)&&(o?h(o,s.item):o=l(s.item),!a)||2&r&&c.push(s.children);return o}var p=35,m="node",g="node-sm",y="focus-",w="mark-";function C(t,e){if(e.hasDelta&&e.maxDelta){const n=t.delta||0,i=Math.abs(n/e.maxDelta);return function(t,e,n){const i=Math.floor(6*t),s=6*t-i,r=n*(1-e),o=n*(1-s*e),l=n*(1-(1-s)*e);let h,c,a;switch(i%6){case 0:h=n,c=l,a=r;break;case 1:h=o,c=n,a=r;break;case 2:h=r,c=n,a=l;break;case 3:h=r,c=o,a=n;break;case 4:h=l,c=r,a=n;break;case 5:h=n,c=r,a=o}return"rgb("+Math.round(255*h)+","+Math.round(255*c)+","+Math.round(255*a)+")"}(0<=n?0:.28,i,.8+.2*i)}let n=0;const i=t.name;if(i){const t=6,e=t<i.length?t:i.length,s=10;let r=0;for(let t=0,o=1;t<e;++t,o*=.7)n+=o*(i.charCodeAt(t)%s),r+=o*(s-1);r>0&&(n/=r)}return"rgb("+(200+Math.round(55*n))+","+Math.round(230*(1-n))+","+Math.round(55*(1-n))+")"}function v(t,e){let n=t.name+", total: "+t.toal+", self: "+t.self;return e.hasDelta&&(n+=", Î”: "+t.delta),n}function x(t,e){const n=t.width<=p;let i=n?g:m;const s=3&t.bits;s&&(i+=" "+y+s);const r=9&t.mark;r&&(i+=" "+w+r),this.className=i,this.textContent=n?"":t.name}function k(t,e){this.innerText=v(t,e)}function b(t,n,i,s){let r="Total: "+t.length+" items";n&&(r+=", value="+c(n),e&&(r+=", delta="+a(n))),r+="; Focus: "+i.length+" items",s&&(r+=", value="+c(s),e&&(r+=", delta="+a(s))),this.innerHTML=r}class E{constructor(){this.frames=[],this.frameCounts=new Map}push(t){const e=this.frameCounts.get(t);this.frameCounts.set(t,e?e+1:1),this.frames.push(t)}pop(t){let e,n;for(;t<this.frames.length;)e=this.frames.pop(),(n=this.frameCounts.get(e))>1?this.frameCounts.set(e,n-1):this.frameCounts.delete(e)}recursive(t){return 0<this.frameCounts.get(t)}}function M(e,n){let r,o,c,a,d,f,p,m;const g=[];for(r=n.length;r--;)if((o=i(n[r]))&&(c=o.length))for(;c--;)g.push(o[c]);const y=t,w=Array(g.length).fill(0),C=new E,v=new Map;for(;a=g.pop();)if(d=w.pop(),f=s(a),p=C.recursive(f),!y&&p||((m=v.get(f))?(h(m.item,a),p||m.roots.push(a)):((m=new u(e,l(a),f)).roots=[a],m.dir=!0,v.set(f,m))),(o=i(a))&&(c=o.length))for(C.pop(d++),C.push(f);c--;)g.push(o[c]),w.push(d);return v.size?Array.from(v.values()):null}function D(n){if(!n||!n.length)return;let i,s,l,h,c,a,u;const d=e,f=!t,p=[],m=[];for(i=n.length;i--;)(s=n[i]).total=s.self=r(s.item),d&&(s.delta=o(s.item)),(l=s.children)&&l.length&&(p.push(l),m.push(l));for(;h=p.pop();){for(c=0,i=h.length;i--;)c+=(s=h[i]).total=s.self=r(s.item),d&&(s.delta=o(s.item)),(l=s.children)&&l.length&&(p.push(l),m.push(l));f&&((u=s.parent).self=u.self-c)}if(!f)for(i=m.length;i--;){for(c=0,a=(h=m[i]).length;a--;)c+=h[a].total;(u=h[0].parent).total=u.total+c}}function _(t){let n,i,s,r;const o=e,l=[t];for(;n=l.pop();)for(i=n.length;i--;)(s=n[i]).self=0,s.total=Math.abs(c(s.item)),o&&(s.delta=a(s.item)),(r=s.children)&&r.length&&l.push(r)}function T(t){if(void 0===t.children){const e=t.children=M(t,t.roots);e&&_(e)}}function N(t,e){return t.total-e.total}class S{constructor(){this.nodes=null,this.height=0,this.rowHeight=0,this.context=new d,this.reference=0}}const H=document.createElement("div"),W=document.createElement("div"),I=document.createElement("div"),V=document.createElement("div");H.className="d3-flame-graph",W.className="search",I.className="nodes-space",V.className="nodes",I.appendChild(V),H.appendChild(W),H.appendChild(I);const A=new class{constructor(){this.totalWidth=0,this.nodeWidthMin=0,this.rowHeight=18,this.hasDelta=!1,this.order=N}layout(t,e,n){let i,s,r,o,l,h,c,a,u,d,f,p,m,g=0;const y=[],w=this.totalWidth,C=this.nodeWidthMin,v=this.rowHeight,x=this.hasDelta,k=this.order,b=[];i=e||t;do{b.push(i)}while(i=i.parent);for(s=b.length;s--;)(i=b[s]).width=w,i.x=0,i.y=g,i.mark&=7,i.bits=252&i.bits|(0===s?3:2),i.ref=n,y.push(i),g+=v;let E=x?Math.abs(i.delta):0;const M=[e];for(;i=M.pop();)if((r=i.children)&&(l=r.length)){if(k&&r.sort(k),o=i.y+v,h=i.dir)for(c=0,s=l;s--;)c=c<(a=Math.abs(r[s].total))?a:c;else for(c=Math.abs(i.self),s=l;s--;)c+=Math.abs(r[s].total);for(u=0<c?i.width/c:0,f=i.x,s=l;s--;)d=r[s],(p=Math.floor(Math.abs(d.total)*u))<C?3&d.mark&&(i.mark|=8):(d.width=p,d.x=f,d.y=o,h?o+=v:(f+=p,M.push(d)),x&&E<(m=Math.abs(d.delta))&&(E=m),d.mark&=7,d.bits&=252,d.ref=n,y.push(d));g<o&&(g=o)}const D=new S;return D.nodes=y,D.height=g,D.rowHeight=v,D.context.hasDelta=x,D.context.maxDelta=E,D.reference=n,D}},L=new class{constructor(t){this.element=t,this.searchContent=b,this.predicate=null,this.marked=null}search(t){this.predicate=function(t){if(!t)return null;if("function"==typeof t)return t;if(!(t=String(t)).length)return null;if(t.startsWith("#")){const e=t.slice(1);return function(t){return t.name===e}}if(1<t.length&&('"'===t[0]||"'"===t[0])&&t[0]===t[t.length-1]){const e=t.slice(1,-1);return function(t){return t.name.includes(e)}}const e=new RegExp(t);return function(t){return e.test(t.name)}}(t)}updateSearch(t){if(this.predicate||this.marked){const e=function(t,e){let n,i,s,r,o;const l=[t],h=[];for(;n=l.pop();)for(i=n.length;i--;){if(o=(s=n[i]).parent,e&&e(s))for(h.push(s),s.mark=o&&5&o.mark?5:1;o&&!(2&o.mark);o=o.parent)o.mark|=2;else s.mark=o&&5&o.mark?4:0;(r=s.children)&&r.length&&l.push(r)}return h}([t],this.predicate);this.marked=this.predicate?e:null}}updateView(t){if(this.marked){const e=function(t){const e=[];let n,i,s,r;const o=[t];for(;n=o.pop();)for(i=n.length;i--;)1&(r=(s=n[i]).mark)&&e.push(s),2&r&&o.push(s.children);return e}([t]),n=f([B]),i=f([t]);this.searchContent.call(this.element,this.marked,n,e,i),this.element.style.display="block"}else this.element.style.display="none"}}(W),K=new class{constructor(t){this.container=t,this.nodeColor=C,this.nodeTitle=null,this.nodeContent=x,this.inverted=!1,this.context=null,this.nodes=null,this.reference=!1,this.unusedElements=[]}render(t){let e,n,i,s;const r=this.unusedElements;if((e=this.nodes)&&this.reference!==t.reference){const s=t.reference;for(n=e.length;n--;)(i=e[n]).ref!==s&&(i.element.style.display="none")}const o=this.container,l=this.nodeColor,h=this.nodeTitle,c=this.nodeContent,a=this.inverted?t.height-t.rowHeight:0,u=this.context=t.context;for(this.nodes=e=t.nodes,this.reference=t.reference,n=e.length;n--;)(s=(i=e[n]).element)||((s=r.pop())||((s=document.createElement("div")).addEventListener("click",G),s.addEventListener("mouseenter",J),s.addEventListener("mouseleave",Q),s.addEventListener("mousemove",U),o.appendChild(s)),i.element=s,s.__node__=i),s.style.width=i.width+"px",s.style.left=i.x+"px",s.style.top=Math.abs(i.y-a)+"px",s.style.backgroundColor=l(i,u),s.title=h?h(i,u):"",c.call(s,i,u),s.style.display="block";this.nodes=e}recycle(t){let e,n,i,s,r;const o=[t];for(;e=o.pop();)for(n=e.length;n--;)(s=(i=e[n]).element)&&(s.__node__=null,this.unusedElements.push(s)),(r=i.children)&&o.push(r)}}(V),R=new class{constructor(t){this.shown=!1,this.nodeTip=null,this.element=document.createElement("div"),this.element.className="tip",this.tipDx=0,this.tipDy=0,t.appendChild(this.element),this.deterringElement=document.createElement("div")}show(t,e,n,i){const s=e.getBoundingClientRect(),r=e.parentElement.getBoundingClientRect();this.nodeTip.call(this.element,n,i),this.element.visibility="hidden",this.element.style.display="block";const o=this.element.getBoundingClientRect(),l=document.documentElement.clientWidth,h=document.documentElement.clientHeight,c=t.clientX,a=t.clientY,u=s.height;let d=c+u,f=a+u;l<d+o.width&&(d=l-o.width),h<f+o.height&&(f=a-u-o.height),d-=r.left,f-=r.top,this.tipDx=c-d,this.tipDy=a-f,e.appendChild(this.deterringElement),this.element.style.transform="translate("+d+"px,"+f+"px)",this.element.visibility="visible",this.shown=!0}hide(){if(this.shown){const t=this.deterringElement.parentElement;t&&t.removeChild(this.deterringElement),this.element.style.display="none",this.shown=!1}}update(t){if(this.shown){const e=t.clientX-this.tipDx,n=t.clientY-this.tipDy;this.element.style.transform="translate("+e+"px,"+n+"px)"}}}(I);var B=null,j=null,z=null,F=null,X=null,Y=null,O=null;function P(){const t=V.getBoundingClientRect();A.totalWidth=t.width,A.hasDelta=e;const n=A.layout(B,j,!K.reference);V.style.height=n.height+"px",K.render(n),L.updateView(j)}const Z={shiftKey:!1,handleEvent(t){switch(t.type){case"keydown":case"keyup":this.shiftKey=t.shiftKey}},listen(){document.addEventListener("keydown",this,!1),document.addEventListener("keyup",this,!1)},textSelected:()=>"Range"===window.getSelection().type};function q(t){j=t,F&&(F(t),L.updateSearch(B)),P()}function G(){if(!Z.textSelected()){R.hide();const t=this.__node__;q(t),O&&O.call(this,t)}}function J(t){R.nodeTip&&(Z.shiftKey&&R.shown||R.show(t,this,this.__node__,K.context))}function Q(t){Z.shiftKey||R.hide()}function U(t){!Z.shiftKey&&R.shown&&R.update(t)}function $(t,e,n){return"function"==typeof t?t:t?e:n}function tt(t){return V.style.width=X?X+"px":"100%",V.style.height=Y?Y+"px":"0px",t.appendChild(H),tt}return Z.listen(),tt.selfValue=function(e){return arguments.length?(t=e,tt):t},tt.hasDelta=function(t){return arguments.length?(e=t,tt):e},tt.getItemName=function(t){return arguments.length?(s=t,tt):s},tt.getItemValue=function(t){return arguments.length?(r=t,tt):r},tt.getItemDelta=function(t){return arguments.length?(o=t,tt):o},tt.getItemChildren=function(t){return arguments.length?(i=t,tt):i},tt.createAggregatedItem=function(t){return arguments.length?(l=t,tt):l},tt.addAggregatedItem=function(t){return arguments.length?(h=t,tt):h},tt.getAggregatedItemValue=function(t){return arguments.length?(c=t,tt):c},tt.getAggregatedItemDelta=function(t){return arguments.length?(a=t,tt):a},tt.getNodeColor=function(t){return arguments.length?(K.nodeColor=t||C,tt):K.nodeColor},tt.getNodeTitle=function(t){return arguments.length?(K.nodeTitle=$(t,v,null),tt):K.nodeTitle},tt.setNodeContent=function(t){return arguments.length?(K.nodeContent=t||x,tt):K.nodeContent},tt.setNodeTip=function(t){return arguments.length?(R.nodeTip=$(t,k,null),tt):R.nodeTip},tt.setSearchContent=function(t){return arguments.length?(L.searchContent=$(t,b,null),tt):L.searchContent},tt.cellHeight=function(t){return arguments.length?(A.rowHeight=t,tt):A.rowHeight},tt.cellWidthMin=function(t){return arguments.length?(A.nodeWidthMin=t,tt):A.nodeWidthMin},tt.sort=function(t){return arguments.length?(A.order=$(t,N,null),tt):A.order},tt.inverted=function(t){return arguments.length?(K.inverted=t,tt):K.inverted},tt.height=function(t){return arguments.length?(Y=t,tt):Y},tt.width=function(t){return arguments.length?(X=t,tt):X},tt.createItemsView=function(t){return B&&K.recycle([B]),j=B=function(t){let e,r,o,l,h,c,a,d;const f=n(t),p=new u(null,f,s(f)),m=[[p]],g=[];for(;e=m.pop();)for(r=e.length;r--;)if(o=e[r],(l=i(o.item))&&(h=l.length)){for(c=[];h--;)d=new u(o,a=l[h],s(a)),c.push(d);o.children=c,m.push(c),g.push(c)}return D([p]),p}(t),z=D,F=null,L.updateSearch(B),P(),tt},tt.createFlattenView=function(t){return B&&K.recycle([B]),j=B=function(t){const e=n(t),i=new u(null,l(e),s(e));return i.roots=[e],i.children=M(i,i.roots),i.dir=!0,_([i]),i}(t),z=_,F=T,L.updateSearch(B),P(),tt},tt.updateValues=function(){return z([B]),P(),tt},tt.search=function(t){L.search(t),L.updateSearch(B),P()},tt.clear=function(){L.search(null),L.updateSearch(B),P()},tt.onClick=function(t){return arguments.length?(O=t,tt):O},tt.zoomTo=function(t){q(t)},tt.resetZoom=function(){q(B)},tt},Object.defineProperty(t,"__esModule",{value:!0})});